#!/usr/bin/env python3

import cv2
import numpy as np
import time
import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image
from cv_bridge import CvBridge


class MarkerDetectEstimate(Node):
    def __init__(self):
        super().__init__('MarkerDetecter')  # ROS 2 ë…¸ë“œ ì´ˆê¸°í™”

        # âœ… OpenCV-ROS ë³€í™˜ ë¸Œë¦¬ì§€ ìƒì„±
        self.bridge = CvBridge()

        # âœ… í•„ìš”í•œ ì¸ìë“¤ ì´ˆê¸°í™”
        self.ZedCvImage = None  # ZED ì¹´ë©”ë¼ì—ì„œ ë°›ì€ ì´ë¯¸ì§€
        self.MarkerSize = 0.2  # 20cm ë§ˆì»¤ í¬ê¸°
        self.FrameUndistorted = None  # ì™œê³¡ ë³´ì •ëœ ì´ë¯¸ì§€

        # âœ… ZED ì¹´ë©”ë¼ ì´ë¯¸ì§€ êµ¬ë… (left_gray ì´ë¯¸ì§€ ì‚¬ìš©)
        self.st_SubZEDImage = self.create_subscription(
            Image,
            '/zed/zed_node/left_gray/image_rect_gray',
            self.ZEDImageCallBack,
            10
        )

        # âœ… ì¹´ë©”ë¼ ë‚´ë¶€ í–‰ë ¬ (Intrinsic Matrix)
        self.st_IntrinsicParameter = np.array([
            [519.5989379882812, 0, 645.4970092773438],
            [0, 519.5989379882812, 364.4530944824219],
            [0, 0, 1]
        ], dtype=np.float32)

        # âœ… ì™œê³¡ ê³„ìˆ˜ (Distortion Coefficients)
        self.st_DistortionParameter = np.zeros((1, 12), dtype=np.float32)

        # âœ… ArUco ê²€ì¶œê¸° ì„¤ì •
        self.Dict_AruCo = cv2.aruco.getPredefinedDictionary(cv2.aruco.DICT_6X6_50)
        self.AruCoParams = cv2.aruco.DetectorParameters()
        self.ArucoDetector = cv2.aruco.ArucoDetector(self.Dict_AruCo, self.AruCoParams)

        # âœ… ZED ì¹´ë©”ë¼ì—ì„œ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ë°›ì„ ë•Œê¹Œì§€ ëŒ€ê¸°
        while self.ZedCvImage is None:
            print("ğŸ“Œ Waiting for ZED image...")
            rclpy.spin_once(self)  # ROS ë©”ì‹œì§€ê°€ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°

        print("âœ… ZED image received! Starting ArUco detection...")

    def ZEDImageCallBack(self, msg):
        """
        ğŸ“Œ ZED ì¹´ë©”ë¼ì—ì„œ ì´ë¯¸ì§€ë¥¼ ìˆ˜ì‹ í•˜ë©´ OpenCV í¬ë§·ìœ¼ë¡œ ë³€í™˜ í›„ ì²˜ë¦¬
        """
        self.ZedCvImage = self.bridge.imgmsg_to_cv2(msg, desired_encoding="mono8")
        self.process_frame()

    def undistort_frame(self, frame):
        """
        ğŸ“Œ ì…ë ¥ ì´ë¯¸ì§€ë¥¼ ì™œê³¡ ë³´ì •
        """
        return cv2.undistort(frame, self.st_IntrinsicParameter, self.st_DistortionParameter)

    def detect_markers_and_estimate_pose(self, frame):
        """
        ğŸ“Œ ArUco ë§ˆì»¤ ê²€ì¶œ ë° 3D í¬ì¦ˆ ì¶”ì •
        """
        corners, ids, _ = self.ArucoDetector.detectMarkers(frame)
        if ids is not None:
            cv2.aruco.drawDetectedMarkers(frame, corners, ids)
            rvecs, tvecs, _ = cv2.aruco.estimatePoseSingleMarkers(
                corners, self.MarkerSize, self.st_IntrinsicParameter, self.st_DistortionParameter
            )
            return corners, ids, rvecs, tvecs
        return None, None, None, None

    def display_marker_info(self, frame, corners, ids, rvecs, tvecs):
        """
        ğŸ“Œ ê²€ì¶œëœ ë§ˆì»¤ì˜ ì •ë³´ë¥¼ í™”ë©´ì— ì¶œë ¥
        """
        for i in range(len(ids)):
            corner = corners[i][0]
            center_x = int(np.mean(corner[:, 0]))
            center_y = int(np.mean(corner[:, 1]))

            pos_x, pos_y, pos_z = tvecs[i][0]
            rot_matrix, _ = cv2.Rodrigues(rvecs[i])
            euler_angles = cv2.RQDecomp3x3(rot_matrix)[0]

            cv2.drawFrameAxes(frame, self.st_IntrinsicParameter, self.st_DistortionParameter, rvecs[i], tvecs[i], self.MarkerSize / 2)

            cv2.putText(frame, f"ID: {ids[i][0]}", (center_x, center_y - 40),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0), 2)

            cv2.putText(frame, f"Pos: ({pos_x:.2f}, {pos_y:.2f}, {pos_z:.2f})m",
                        (center_x, center_y), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0), 2)

            cv2.putText(frame, f"Rot: ({euler_angles[0]:.1f}, {euler_angles[1]:.1f}, {euler_angles[2]:.1f})deg",
                        (center_x, center_y + 20), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0), 2)

    def process_frame(self):
        """
        ğŸ“Œ ZED ì¹´ë©”ë¼ë¡œ ë°›ì€ ì´ë¯¸ì§€ ì²˜ë¦¬ â†’ ì™œê³¡ ë³´ì • â†’ ë§ˆì»¤ ê²€ì¶œ ë° ì •ë³´ ì¶œë ¥
        """
        if self.ZedCvImage is None:
            return

        # ğŸ”¹ ì´ë¯¸ì§€ ì™œê³¡ ë³´ì •
        self.FrameUndistorted = self.undistort_frame(self.ZedCvImage)

        # ğŸ”¹ ArUco ë§ˆì»¤ ê²€ì¶œ ë° 3D í¬ì¦ˆ ì¶”ì •
        corners, ids, rvecs, tvecs = self.detect_markers_and_estimate_pose(self.FrameUndistorted)

        # ğŸ”¹ ê²€ì¶œëœ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì •ë³´ ì¶œë ¥
        if ids is not None:
            self.display_marker_info(self.FrameUndistorted, corners, ids, rvecs, tvecs)

        # ğŸ”¹ ê²°ê³¼ ì´ë¯¸ì§€ ì¶œë ¥
        cv2.imshow("ZED Image with ArUco Detection", self.FrameUndistorted)
        cv2.waitKey(1)


def main(args=None):
    """
    ğŸ“Œ ROS 2 ë…¸ë“œë¥¼ ì´ˆê¸°í™”í•˜ê³  ArUco ë§ˆì»¤ ê²€ì¶œ ì‹¤í–‰
    """
    rclpy.init(args=args)
    RosNode = MarkerDetectEstimate()
    
    try:
        rclpy.spin(RosNode)  # ROS 2 ë…¸ë“œ ì‹¤í–‰
    except KeyboardInterrupt:
        print("ğŸ”´ Shutting down ArUco detection.")

    RosNode.destroy_node()
    rclpy.shutdown()
    cv2.destroyAllWindows()  # ëª¨ë“  OpenCV ì°½ ë‹«ê¸°


if __name__ == '__main__':
    main()

